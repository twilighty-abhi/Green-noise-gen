<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="description" content="Scientific sound generator for productivity and sleep - featuring white, pink, brown noise and binaural beats">
    <title>Sleep Serene - Focus & Sleep</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Productivity Mode - Warm, energizing */
            --prod-primary: #f59e0b;
            --prod-secondary: #fbbf24;
            --prod-bg: #0f0f14;
            --prod-surface: #1a1a24;
            --prod-glow: rgba(245, 158, 11, 0.15);
            
            /* Sleep Mode - Cool, calming */
            --sleep-primary: #6366f1;
            --sleep-secondary: #818cf8;
            --sleep-bg: #0a0a12;
            --sleep-surface: #12121c;
            --sleep-glow: rgba(99, 102, 241, 0.15);
            
            /* Current theme (default: productivity) */
            --primary: var(--prod-primary);
            --secondary: var(--prod-secondary);
            --bg: var(--prod-bg);
            --surface: var(--prod-surface);
            --glow: var(--prod-glow);
            
            /* Neutrals */
            --text: #f5f5f7;
            --text-muted: #8b8b9e;
            --border: rgba(255, 255, 255, 0.08);
            
            /* Spacing */
            --radius: 16px;
            --radius-sm: 10px;
        }
        
        [data-mode="sleep"] {
            --primary: var(--sleep-primary);
            --secondary: var(--sleep-secondary);
            --bg: var(--sleep-bg);
            --surface: var(--sleep-surface);
            --glow: var(--sleep-glow);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            transition: background 0.5s ease;
        }
        
        /* Animated background */
        .bg-gradient {
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 50% -20%, var(--glow), transparent),
                radial-gradient(ellipse 60% 40% at 80% 100%, var(--glow), transparent);
            pointer-events: none;
            z-index: 0;
            transition: background 0.5s ease;
        }
        
        .container {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            padding: 24px 20px;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        header {
            text-align: center;
            margin-bottom: 28px;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
        }
        
        .logo span {
            color: var(--primary);
            transition: color 0.3s;
        }
        
        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            background: var(--surface);
            border-radius: 100px;
            padding: 4px;
            margin: 0 auto;
            width: fit-content;
            border: 1px solid var(--border);
        }
        
        .mode-btn {
            padding: 10px 24px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 100px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mode-btn.active {
            background: var(--primary);
            color: #000;
        }
        
        .mode-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* Sound Grid */
        .sound-section {
            flex: 1;
        }
        
        .section-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        .sound-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .sound-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .sound-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sound-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .sound-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 30px var(--glow);
        }
        
        .sound-card.active::before {
            opacity: 0.1;
        }
        
        .sound-card-content {
            position: relative;
            z-index: 1;
        }
        
        .sound-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 1.25rem;
        }
        
        .sound-card.active .sound-icon {
            background: var(--primary);
        }
        
        .sound-name {
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 4px;
        }
        
        .sound-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.4;
        }
        
        .sound-tag {
            display: inline-block;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 4px 8px;
            border-radius: 100px;
            background: rgba(255, 255, 255, 0.05);
            margin-top: 8px;
        }
        
        .sound-card.binaural .sound-tag {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }
        
        .headphone-notice {
            display: none;
            align-items: center;
            gap: 6px;
            font-size: 0.6875rem;
            color: var(--primary);
            margin-top: 6px;
        }
        
        .sound-card.binaural .headphone-notice {
            display: flex;
        }
        
        .headphone-notice svg {
            width: 14px;
            height: 14px;
        }
        
        /* Playback Controls */
        .controls {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .now-playing {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .play-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px var(--glow);
        }
        
        .play-btn:active {
            transform: scale(0.95);
        }
        
        .play-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .play-btn .pause-icon {
            display: none;
        }
        
        .play-btn.playing .play-icon {
            display: none;
        }
        
        .play-btn.playing .pause-icon {
            display: block;
        }
        
        .track-info {
            flex: 1;
            min-width: 0;
        }
        
        .track-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-type {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Visualizer */
        .visualizer {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
            height: 32px;
        }
        
        .visualizer-bar {
            width: 4px;
            background: var(--primary);
            border-radius: 2px;
            transition: height 0.1s ease;
            opacity: 0.3;
        }
        
        .playing .visualizer-bar {
            opacity: 1;
            animation: visualize 0.8s ease-in-out infinite;
        }
        
        .visualizer-bar:nth-child(1) { animation-delay: 0s; }
        .visualizer-bar:nth-child(2) { animation-delay: 0.1s; }
        .visualizer-bar:nth-child(3) { animation-delay: 0.2s; }
        .visualizer-bar:nth-child(4) { animation-delay: 0.3s; }
        .visualizer-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes visualize {
            0%, 100% { height: 8px; }
            50% { height: 28px; }
        }
        
        /* Volume Control */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .volume-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        
        .volume-btn:hover {
            color: var(--text);
        }
        
        .volume-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .volume-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            cursor: pointer;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }
        
        .volume-value {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            width: 36px;
            text-align: right;
        }
        
        /* Timer */
        .timer-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 16px;
        }
        
        .timer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .timer-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .timer-label svg {
            width: 16px;
            height: 16px;
        }
        
        .timer-display {
            font-size: 1.5rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            color: var(--primary);
        }
        
        .timer-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .timer-preset {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 100px;
            font-family: inherit;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .timer-preset:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
        }
        
        .timer-preset.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #000;
        }
        
        /* Info Panel */
        .info-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 16px;
        }
        
        .info-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .info-header svg {
            width: 18px;
            height: 18px;
            color: var(--primary);
        }
        
        .info-title {
            font-size: 0.8125rem;
            font-weight: 600;
        }
        
        .info-text {
            font-size: 0.8125rem;
            color: var(--text-muted);
            line-height: 1.6;
        }
        
        .info-specs {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        .spec {
            text-align: center;
        }
        
        .spec-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .spec-label {
            font-size: 0.6875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 16px 0;
            margin-top: auto;
        }
        
        .footer-text {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .keyboard-hint {
            display: none;
            margin-top: 8px;
            font-size: 0.6875rem;
            color: var(--text-muted);
        }
        
        @media (min-width: 768px) {
            .keyboard-hint {
                display: block;
            }
        }
        
        kbd {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.625rem;
        }
        
        /* Headphone Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            max-width: 360px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.show .modal {
            transform: scale(1);
        }
        
        .modal-icon {
            width: 64px;
            height: 64px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        
        .modal-icon svg {
            width: 32px;
            height: 32px;
            color: #a78bfa;
        }
        
        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .modal-text {
            font-size: 0.875rem;
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: 24px;
        }
        
        .modal-btn {
            width: 100%;
            padding: 14px 24px;
            background: var(--primary);
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.9375rem;
            font-weight: 600;
            color: #000;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .modal-btn:hover {
            transform: scale(1.02);
        }
        
        /* Loading */
        .loading {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            transition: opacity 0.5s ease;
        }
        
        .loading.hide {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--surface);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* PWA Install */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            display: none;
            align-items: center;
            gap: 16px;
            z-index: 50;
            max-width: 440px;
            margin: 0 auto;
        }
        
        .install-prompt.show {
            display: flex;
        }
        
        .install-text {
            flex: 1;
        }
        
        .install-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 4px;
        }
        
        .install-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .install-btn {
            padding: 10px 20px;
            background: var(--primary);
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #000;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .install-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
    </div>

    <!-- Background -->
    <div class="bg-gradient"></div>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header>
            <h1 class="logo">Sleep <span>Serene</span></h1>
            
            <!-- Mode Toggle -->
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="productivity">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/>
                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                    </svg>
                    Focus
                </button>
                <button class="mode-btn" data-mode="sleep">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                    Sleep
                </button>
            </div>
        </header>
        
        <!-- Sound Selection -->
        <section class="sound-section">
            <div class="section-label">Select Sound</div>
            
            <!-- Productivity Sounds -->
            <div class="sound-grid" id="productivity-sounds">
                <div class="sound-card" data-sound="white-noise">
                    <div class="sound-card-content">
                        <div class="sound-icon">üìª</div>
                        <div class="sound-name">White Noise</div>
                        <div class="sound-desc">All frequencies at equal power</div>
                        <span class="sound-tag">Classic</span>
                    </div>
                </div>
                
                <div class="sound-card" data-sound="pink-noise">
                    <div class="sound-card-content">
                        <div class="sound-icon">üå∏</div>
                        <div class="sound-name">Pink Noise</div>
                        <div class="sound-desc">Balanced -3dB/octave rolloff</div>
                        <span class="sound-tag">Popular</span>
                    </div>
                </div>
                
                <div class="sound-card" data-sound="brown-noise">
                    <div class="sound-card-content">
                        <div class="sound-icon">ü™µ</div>
                        <div class="sound-name">Brown Noise</div>
                        <div class="sound-desc">Deep, rumbling -6dB/octave</div>
                        <span class="sound-tag">Deep Focus</span>
                    </div>
                </div>
                
                <div class="sound-card" data-sound="focus-rain">
                    <div class="sound-card-content">
                        <div class="sound-icon">üåßÔ∏è</div>
                        <div class="sound-name">Focus Rain</div>
                        <div class="sound-desc">Steady rainfall for concentration</div>
                        <span class="sound-tag">Nature</span>
                    </div>
                </div>
                
                <div class="sound-card binaural" data-sound="beta-beats">
                    <div class="sound-card-content">
                        <div class="sound-icon">üß†</div>
                        <div class="sound-name">Beta Beats</div>
                        <div class="sound-desc">18Hz for active thinking</div>
                        <span class="sound-tag">Binaural</span>
                        <div class="headphone-notice">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 18v-6a9 9 0 0 1 18 0v6"/>
                                <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>
                            </svg>
                            Headphones required
                        </div>
                    </div>
                </div>
                
                <div class="sound-card binaural" data-sound="gamma-beats">
                    <div class="sound-card-content">
                        <div class="sound-icon">‚ö°</div>
                        <div class="sound-name">Gamma Beats</div>
                        <div class="sound-desc">40Hz for peak concentration</div>
                        <span class="sound-tag">Binaural</span>
                        <div class="headphone-notice">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 18v-6a9 9 0 0 1 18 0v6"/>
                                <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>
                            </svg>
                            Headphones required
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sleep Sounds -->
            <div class="sound-grid" id="sleep-sounds" style="display: none;">
                <div class="sound-card" data-sound="pink-sleep">
                    <div class="sound-card-content">
                        <div class="sound-icon">üåô</div>
                        <div class="sound-name">Pink Sleep</div>
                        <div class="sound-desc">Enhances deep sleep stages</div>
                        <span class="sound-tag">Research-backed</span>
                    </div>
                </div>
                
                <div class="sound-card" data-sound="brown-sleep">
                    <div class="sound-card-content">
                        <div class="sound-icon">üõèÔ∏è</div>
                        <div class="sound-name">Brown Sleep</div>
                        <div class="sound-desc">Deep, calming rumble</div>
                        <span class="sound-tag">Soothing</span>
                    </div>
                </div>
                
                <div class="sound-card" data-sound="ocean-waves">
                    <div class="sound-card-content">
                        <div class="sound-icon">üåä</div>
                        <div class="sound-name">Ocean Waves</div>
                        <div class="sound-desc">Rhythmic, breathing pattern</div>
                        <span class="sound-tag">Nature</span>
                    </div>
                </div>
                
                <div class="sound-card" data-sound="night-rain">
                    <div class="sound-card-content">
                        <div class="sound-icon">üåßÔ∏è</div>
                        <div class="sound-name">Night Rain</div>
                        <div class="sound-desc">Gentle rain on leaves</div>
                        <span class="sound-tag">Nature</span>
                    </div>
                </div>
                
                <div class="sound-card binaural" data-sound="delta-beats">
                    <div class="sound-card-content">
                        <div class="sound-icon">üí§</div>
                        <div class="sound-name">Delta Beats</div>
                        <div class="sound-desc">2Hz for deep sleep induction</div>
                        <span class="sound-tag">Binaural</span>
                        <div class="headphone-notice">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 18v-6a9 9 0 0 1 18 0v6"/>
                                <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>
                            </svg>
                            Headphones required
                        </div>
                    </div>
                </div>
                
                <div class="sound-card binaural" data-sound="theta-beats">
                    <div class="sound-card-content">
                        <div class="sound-icon">üßò</div>
                        <div class="sound-name">Theta Beats</div>
                        <div class="sound-desc">6Hz for falling asleep</div>
                        <span class="sound-tag">Binaural</span>
                        <div class="headphone-notice">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 18v-6a9 9 0 0 1 18 0v6"/>
                                <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>
                            </svg>
                            Headphones required
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Playback Controls -->
        <div class="controls" id="controls">
            <div class="now-playing">
                <button class="play-btn" id="playBtn">
                    <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 4h4v16H6zM14 4h4v16h-4z"/>
                    </svg>
                </button>
                
                <div class="track-info">
                    <div class="track-name" id="trackName">Select a sound</div>
                    <div class="track-type" id="trackType">Choose from above to begin</div>
                </div>
                
                <div class="visualizer" id="visualizer">
                    <div class="visualizer-bar" style="height: 12px;"></div>
                    <div class="visualizer-bar" style="height: 20px;"></div>
                    <div class="visualizer-bar" style="height: 16px;"></div>
                    <div class="visualizer-bar" style="height: 24px;"></div>
                    <div class="visualizer-bar" style="height: 14px;"></div>
                </div>
            </div>
            
            <div class="volume-control">
                <button class="volume-btn" id="muteBtn">
                    <svg id="volumeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                    </svg>
                </button>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="40">
                <span class="volume-value" id="volumeValue">40%</span>
            </div>
        </div>
        
        <!-- Timer -->
        <div class="timer-section">
            <div class="timer-header">
                <div class="timer-label">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Timer
                </div>
                <div class="timer-display" id="timerDisplay">--:--</div>
            </div>
            
            <div class="timer-presets" id="timerPresets">
                <!-- Productivity presets (default) -->
                <button class="timer-preset" data-minutes="25">25m</button>
                <button class="timer-preset" data-minutes="50">50m</button>
                <button class="timer-preset" data-minutes="90">90m</button>
                <button class="timer-preset" data-minutes="0">Off</button>
            </div>
        </div>
        
        <!-- Info Panel -->
        <div class="info-panel" id="infoPanel">
            <div class="info-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4M12 8h.01"/>
                </svg>
                <span class="info-title">The Science</span>
            </div>
            <p class="info-text" id="infoText">
                Select a sound to learn about its scientific benefits and frequency characteristics.
            </p>
            <div class="info-specs" id="infoSpecs" style="display: none;">
                <div class="spec">
                    <div class="spec-value" id="specFreq">-</div>
                    <div class="spec-label">Frequency</div>
                </div>
                <div class="spec">
                    <div class="spec-value" id="specType">-</div>
                    <div class="spec-label">Type</div>
                </div>
                <div class="spec">
                    <div class="spec-value" id="specBest">-</div>
                    <div class="spec-label">Best For</div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer>
            <p class="footer-text">Scientifically designed sounds for focus & rest</p>
            <p class="keyboard-hint">
                <kbd>Space</kbd> Play/Pause &nbsp; <kbd>M</kbd> Mute &nbsp; <kbd>1-6</kbd> Sounds
            </p>
            <p class="footer-text" style="margin-top: 12px;">
                Made with ‚ù§Ô∏è by <a href="https://abhiramnj.com" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none; font-weight: 500;">Abhi</a>
            </p>
        </footer>
    </div>
    
    <!-- Headphone Modal -->
    <div class="modal-overlay" id="headphoneModal">
        <div class="modal">
            <div class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 18v-6a9 9 0 0 1 18 0v6"/>
                    <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>
                </svg>
            </div>
            <h3 class="modal-title">Headphones Required</h3>
            <p class="modal-text">
                Binaural beats work by playing slightly different frequencies in each ear. 
                For the effect to work, you must use headphones or earbuds.
            </p>
            <button class="modal-btn" id="headphoneConfirm">I'm Using Headphones</button>
        </div>
    </div>
    
    <!-- Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <div class="install-text">
            <div class="install-title">Install App</div>
            <div class="install-desc">Add to home screen for offline use</div>
        </div>
        <button class="install-btn" id="installBtn">Install</button>
        <button class="install-close" id="installClose">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <script>
        // ============================================
        // SLEEP SERENE - Scientific Audio Generator
        // ============================================
        
        // Sound Configuration Database
        const SOUNDS = {
            // ========== PRODUCTIVITY SOUNDS ==========
            'white-noise': {
                name: 'White Noise',
                type: 'noise',
                category: 'productivity',
                generator: 'white',
                description: 'Equal energy across all audible frequencies (20Hz-20kHz). White noise effectively masks distracting sounds and has been shown to improve concentration in noisy environments.',
                specs: { freq: '20-20kHz', type: 'Noise', best: 'Masking' }
            },
            'pink-noise': {
                name: 'Pink Noise',
                type: 'noise',
                category: 'productivity',
                generator: 'pink',
                description: 'Power decreases 3dB per octave, resulting in equal energy per octave. Sounds more balanced than white noise and studies show improved work performance compared to silence.',
                specs: { freq: '-3dB/oct', type: 'Noise', best: 'Balance' }
            },
            'brown-noise': {
                name: 'Brown Noise',
                type: 'noise',
                category: 'productivity',
                generator: 'brown',
                description: 'Also called Brownian noise, with 6dB/octave rolloff creating a deep, rumbling sound. Named after Robert Brown. Excellent for deep concentration and blocking low-frequency distractions.',
                specs: { freq: '-6dB/oct', type: 'Noise', best: 'Deep Focus' }
            },
            'focus-rain': {
                name: 'Focus Rain',
                type: 'nature',
                category: 'productivity',
                generator: 'rain',
                description: 'Synthesized rainfall optimized for concentration. The broadband spectrum (1-4kHz emphasis) effectively masks speech and intermittent sounds that typically break focus.',
                specs: { freq: '1-4kHz', type: 'Nature', best: 'Masking' }
            },
            'beta-beats': {
                name: 'Beta Beats',
                type: 'binaural',
                category: 'productivity',
                generator: 'binaural',
                baseFreq: 200,
                beatFreq: 18,
                description: 'Beta brainwaves (13-30Hz) are associated with active thinking, focus, and alertness. This 18Hz binaural beat may help maintain an alert, engaged mental state during tasks.',
                specs: { freq: '18 Hz', type: 'Binaural', best: 'Alertness' }
            },
            'gamma-beats': {
                name: 'Gamma Beats',
                type: 'binaural',
                category: 'productivity',
                generator: 'binaural',
                baseFreq: 200,
                beatFreq: 40,
                description: 'Gamma waves (30-50Hz) are linked to peak concentration, memory formation, and cognitive processing. Research suggests 40Hz stimulation may enhance memory and attention.',
                specs: { freq: '40 Hz', type: 'Binaural', best: 'Memory' }
            },
            
            // ========== SLEEP SOUNDS ==========
            'pink-sleep': {
                name: 'Pink Sleep',
                type: 'noise',
                category: 'sleep',
                generator: 'pink',
                description: 'Pink noise has been shown in studies to enhance deep sleep (N3 stage), increase sleep spindle activity, and improve memory consolidation. The balanced spectrum is gentle on ears during rest.',
                specs: { freq: '-3dB/oct', type: 'Noise', best: 'Deep Sleep' }
            },
            'brown-sleep': {
                name: 'Brown Sleep',
                type: 'noise',
                category: 'sleep',
                generator: 'brown',
                description: 'The deep, low-frequency emphasis creates a enveloping sound similar to distant thunder or a waterfall. Many find this deeply soothing spectrum ideal for relaxation and sleep onset.',
                specs: { freq: '-6dB/oct', type: 'Noise', best: 'Relaxation' }
            },
            'ocean-waves': {
                name: 'Ocean Waves',
                type: 'nature',
                category: 'sleep',
                generator: 'ocean',
                description: 'Rhythmic wave patterns mimic natural breathing cycles, promoting relaxation. The low-frequency dominant spectrum and predictable rhythm help ease the transition to sleep.',
                specs: { freq: '50-500Hz', type: 'Nature', best: 'Rhythm' }
            },
            'night-rain': {
                name: 'Night Rain',
                type: 'nature',
                category: 'sleep',
                generator: 'nightRain',
                description: 'Gentle rainfall with lower intensity optimized for sleep. The continuous, non-intrusive sound provides excellent masking while the randomness prevents pattern recognition that could cause alertness.',
                specs: { freq: '500-3kHz', type: 'Nature', best: 'Calm' }
            },
            'delta-beats': {
                name: 'Delta Beats',
                type: 'binaural',
                category: 'sleep',
                generator: 'binaural',
                baseFreq: 150,
                beatFreq: 2,
                description: 'Delta brainwaves (0.5-4Hz) dominate during deep, dreamless sleep. This 2Hz binaural beat is designed to help guide your brain toward the delta state associated with restorative sleep.',
                specs: { freq: '2 Hz', type: 'Binaural', best: 'Deep Sleep' }
            },
            'theta-beats': {
                name: 'Theta Beats',
                type: 'binaural',
                category: 'sleep',
                generator: 'binaural',
                baseFreq: 150,
                beatFreq: 6,
                description: 'Theta waves (4-8Hz) occur during light sleep and the drowsy transition to sleep. This 6Hz beat may help promote the relaxed, meditative state that precedes sleep onset.',
                specs: { freq: '6 Hz', type: 'Binaural', best: 'Falling Asleep' }
            }
        };
        
        // Timer Presets by Mode
        const TIMER_PRESETS = {
            productivity: [
                { label: '25m', minutes: 25, desc: 'Pomodoro' },
                { label: '50m', minutes: 50, desc: 'Deep work' },
                { label: '90m', minutes: 90, desc: 'Full cycle' },
                { label: 'Off', minutes: 0, desc: '' }
            ],
            sleep: [
                { label: '30m', minutes: 30, desc: 'Power nap' },
                { label: '90m', minutes: 90, desc: 'Sleep cycle' },
                { label: '8h', minutes: 480, desc: 'Full night' },
                { label: 'Off', minutes: 0, desc: '' }
            ]
        };
        
        // ============================================
        // AUDIO ENGINE
        // ============================================
        
        class AudioEngine {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.currentSource = null;
                this.currentSound = null;
                this.isPlaying = false;
                this.volume = 0.4;
                this.isMuted = false;
                
                // For binaural beats
                this.leftOscillator = null;
                this.rightOscillator = null;
                this.merger = null;
                
                // For noise generators
                this.noiseBuffer = null;
                this.noiseSource = null;
                
                // For modulated sounds (ocean, rain)
                this.modulationInterval = null;
            }
            
            async init() {
                if (this.audioContext) return;
                
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.audioContext.createGain();
                this.masterGain.connect(this.audioContext.destination);
                this.masterGain.gain.value = this.volume;
                
                // Pre-generate noise buffers
                await this.generateNoiseBuffers();
            }
            
            async generateNoiseBuffers() {
                const sampleRate = this.audioContext.sampleRate;
                const duration = 4; // 4 seconds of noise
                const bufferSize = sampleRate * duration;
                
                // White noise buffer
                this.whiteBuffer = this.audioContext.createBuffer(1, bufferSize, sampleRate);
                const whiteData = this.whiteBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    whiteData[i] = Math.random() * 2 - 1;
                }
                
                // Pink noise buffer (Paul Kellet's algorithm)
                this.pinkBuffer = this.audioContext.createBuffer(1, bufferSize, sampleRate);
                const pinkData = this.pinkBuffer.getChannelData(0);
                let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    b0 = 0.99886 * b0 + white * 0.0555179;
                    b1 = 0.99332 * b1 + white * 0.0750759;
                    b2 = 0.96900 * b2 + white * 0.1538520;
                    b3 = 0.86650 * b3 + white * 0.3104856;
                    b4 = 0.55000 * b4 + white * 0.5329522;
                    b5 = -0.7616 * b5 - white * 0.0168980;
                    pinkData[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
                    b6 = white * 0.115926;
                }
                
                // Brown noise buffer (random walk / integration)
                this.brownBuffer = this.audioContext.createBuffer(1, bufferSize, sampleRate);
                const brownData = this.brownBuffer.getChannelData(0);
                let lastOut = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    brownData[i] = (lastOut + (0.02 * white)) / 1.02;
                    lastOut = brownData[i];
                    brownData[i] *= 3.5; // Normalize
                }
            }
            
            createNoiseSource(type) {
                let buffer;
                switch (type) {
                    case 'white': buffer = this.whiteBuffer; break;
                    case 'pink': buffer = this.pinkBuffer; break;
                    case 'brown': buffer = this.brownBuffer; break;
                    default: buffer = this.pinkBuffer;
                }
                
                const source = this.audioContext.createBufferSource();
                source.buffer = buffer;
                source.loop = true;
                return source;
            }
            
            createRainSound() {
                // Rain = filtered noise with some high-frequency emphasis
                const source = this.createNoiseSource('white');
                
                // Create filter chain for rain-like sound
                const highpass = this.audioContext.createBiquadFilter();
                highpass.type = 'highpass';
                highpass.frequency.value = 800;
                highpass.Q.value = 0.5;
                
                const lowpass = this.audioContext.createBiquadFilter();
                lowpass.type = 'lowpass';
                lowpass.frequency.value = 8000;
                lowpass.Q.value = 0.7;
                
                const peak = this.audioContext.createBiquadFilter();
                peak.type = 'peaking';
                peak.frequency.value = 3000;
                peak.Q.value = 1;
                peak.gain.value = 6;
                
                source.connect(highpass);
                highpass.connect(lowpass);
                lowpass.connect(peak);
                
                return { source, output: peak };
            }
            
            createNightRainSound() {
                // Gentler rain for sleep
                const source = this.createNoiseSource('pink');
                
                const lowpass = this.audioContext.createBiquadFilter();
                lowpass.type = 'lowpass';
                lowpass.frequency.value = 4000;
                lowpass.Q.value = 0.5;
                
                const highpass = this.audioContext.createBiquadFilter();
                highpass.type = 'highpass';
                highpass.frequency.value = 200;
                highpass.Q.value = 0.3;
                
                source.connect(highpass);
                highpass.connect(lowpass);
                
                return { source, output: lowpass };
            }
            
            createOceanSound() {
                // Ocean = modulated brown noise
                const source = this.createNoiseSource('brown');
                
                // Low-pass for deep ocean sound
                const lowpass = this.audioContext.createBiquadFilter();
                lowpass.type = 'lowpass';
                lowpass.frequency.value = 600;
                lowpass.Q.value = 0.5;
                
                // Create LFO for wave-like modulation
                const lfoGain = this.audioContext.createGain();
                lfoGain.gain.value = 0.7;
                
                source.connect(lowpass);
                lowpass.connect(lfoGain);
                
                // Store for modulation
                this.oceanLfoGain = lfoGain;
                
                // Start wave modulation
                this.startOceanModulation();
                
                return { source, output: lfoGain };
            }
            
            startOceanModulation() {
                // Simulate wave rhythm (roughly 6-8 seconds per wave)
                let phase = 0;
                const waveSpeed = 0.15; // Adjust for wave speed
                
                this.modulationInterval = setInterval(() => {
                    if (this.oceanLfoGain && this.isPlaying) {
                        phase += waveSpeed;
                        // Smooth wave pattern
                        const modValue = 0.5 + 0.4 * Math.sin(phase) + 0.1 * Math.sin(phase * 2.3);
                        this.oceanLfoGain.gain.setTargetAtTime(
                            modValue, 
                            this.audioContext.currentTime, 
                            0.5
                        );
                    }
                }, 100);
            }
            
            createBinauralBeat(baseFreq, beatFreq) {
                // Create stereo binaural beat
                const leftOsc = this.audioContext.createOscillator();
                const rightOsc = this.audioContext.createOscillator();
                
                leftOsc.type = 'sine';
                rightOsc.type = 'sine';
                
                leftOsc.frequency.value = baseFreq;
                rightOsc.frequency.value = baseFreq + beatFreq;
                
                // Create stereo panner
                const merger = this.audioContext.createChannelMerger(2);
                
                const leftGain = this.audioContext.createGain();
                const rightGain = this.audioContext.createGain();
                leftGain.gain.value = 0.5;
                rightGain.gain.value = 0.5;
                
                leftOsc.connect(leftGain);
                rightOsc.connect(rightGain);
                leftGain.connect(merger, 0, 0);
                rightGain.connect(merger, 0, 1);
                
                return { leftOsc, rightOsc, merger };
            }
            
            async play(soundId) {
                await this.init();
                
                // Resume context if suspended
                if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                }
                
                // Stop current sound
                this.stop();
                
                const sound = SOUNDS[soundId];
                if (!sound) return;
                
                this.currentSound = soundId;
                
                if (sound.type === 'binaural') {
                    // Binaural beats
                    const { leftOsc, rightOsc, merger } = this.createBinauralBeat(
                        sound.baseFreq, 
                        sound.beatFreq
                    );
                    
                    this.leftOscillator = leftOsc;
                    this.rightOscillator = rightOsc;
                    this.merger = merger;
                    
                    merger.connect(this.masterGain);
                    leftOsc.start();
                    rightOsc.start();
                    
                } else if (sound.generator === 'rain') {
                    const { source, output } = this.createRainSound();
                    this.noiseSource = source;
                    output.connect(this.masterGain);
                    source.start();
                    
                } else if (sound.generator === 'nightRain') {
                    const { source, output } = this.createNightRainSound();
                    this.noiseSource = source;
                    output.connect(this.masterGain);
                    source.start();
                    
                } else if (sound.generator === 'ocean') {
                    const { source, output } = this.createOceanSound();
                    this.noiseSource = source;
                    output.connect(this.masterGain);
                    source.start();
                    
                } else {
                    // Standard noise
                    const source = this.createNoiseSource(sound.generator);
                    this.noiseSource = source;
                    source.connect(this.masterGain);
                    source.start();
                }
                
                this.isPlaying = true;
            }
            
            stop() {
                if (this.modulationInterval) {
                    clearInterval(this.modulationInterval);
                    this.modulationInterval = null;
                }
                
                if (this.leftOscillator) {
                    this.leftOscillator.stop();
                    this.leftOscillator.disconnect();
                    this.leftOscillator = null;
                }
                
                if (this.rightOscillator) {
                    this.rightOscillator.stop();
                    this.rightOscillator.disconnect();
                    this.rightOscillator = null;
                }
                
                if (this.merger) {
                    this.merger.disconnect();
                    this.merger = null;
                }
                
                if (this.noiseSource) {
                    this.noiseSource.stop();
                    this.noiseSource.disconnect();
                    this.noiseSource = null;
                }
                
                this.isPlaying = false;
            }
            
            pause() {
                if (this.audioContext) {
                    this.audioContext.suspend();
                }
                this.isPlaying = false;
            }
            
            resume() {
                if (this.audioContext && this.currentSound) {
                    this.audioContext.resume();
                    this.isPlaying = true;
                }
            }
            
            setVolume(value) {
                this.volume = value;
                if (this.masterGain) {
                    this.masterGain.gain.setTargetAtTime(
                        this.isMuted ? 0 : value,
                        this.audioContext.currentTime,
                        0.1
                    );
                }
            }
            
            toggleMute() {
                this.isMuted = !this.isMuted;
                if (this.masterGain) {
                    this.masterGain.gain.setTargetAtTime(
                        this.isMuted ? 0 : this.volume,
                        this.audioContext.currentTime,
                        0.1
                    );
                }
                return this.isMuted;
            }
        }
        
        // ============================================
        // APP CONTROLLER
        // ============================================
        
        class SleepSereneApp {
            constructor() {
                this.audioEngine = new AudioEngine();
                this.currentMode = 'productivity';
                this.currentSound = null;
                this.timerInterval = null;
                this.timerRemaining = 0;
                this.wakeLock = null;
                
                this.init();
            }
            
            init() {
                this.bindElements();
                this.bindEvents();
                this.loadPreferences();
                this.registerServiceWorker();
                this.setupPWA();
                
                // Hide loading
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hide');
                }, 500);
            }
            
            bindElements() {
                this.modeButtons = document.querySelectorAll('.mode-btn');
                this.productivitySounds = document.getElementById('productivity-sounds');
                this.sleepSounds = document.getElementById('sleep-sounds');
                this.soundCards = document.querySelectorAll('.sound-card');
                this.playBtn = document.getElementById('playBtn');
                this.trackName = document.getElementById('trackName');
                this.trackType = document.getElementById('trackType');
                this.visualizer = document.getElementById('visualizer');
                this.volumeSlider = document.getElementById('volumeSlider');
                this.volumeValue = document.getElementById('volumeValue');
                this.muteBtn = document.getElementById('muteBtn');
                this.volumeIcon = document.getElementById('volumeIcon');
                this.timerDisplay = document.getElementById('timerDisplay');
                this.timerPresets = document.getElementById('timerPresets');
                this.infoText = document.getElementById('infoText');
                this.infoSpecs = document.getElementById('infoSpecs');
                this.headphoneModal = document.getElementById('headphoneModal');
                this.headphoneConfirm = document.getElementById('headphoneConfirm');
            }
            
            bindEvents() {
                // Mode toggle
                this.modeButtons.forEach(btn => {
                    btn.addEventListener('click', () => this.setMode(btn.dataset.mode));
                });
                
                // Sound selection
                this.soundCards.forEach(card => {
                    card.addEventListener('click', () => this.selectSound(card.dataset.sound));
                });
                
                // Play button
                this.playBtn.addEventListener('click', () => this.togglePlay());
                
                // Volume
                this.volumeSlider.addEventListener('input', (e) => this.setVolume(e.target.value));
                this.muteBtn.addEventListener('click', () => this.toggleMute());
                
                // Timer presets
                this.timerPresets.addEventListener('click', (e) => {
                    if (e.target.classList.contains('timer-preset')) {
                        this.setTimer(parseInt(e.target.dataset.minutes));
                        this.updateTimerPresetUI(e.target);
                    }
                });
                
                // Headphone modal
                this.headphoneConfirm.addEventListener('click', () => {
                    this.headphoneModal.classList.remove('show');
                    if (this.pendingBinauralSound) {
                        this.playSound(this.pendingBinauralSound);
                        this.pendingBinauralSound = null;
                    }
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));
                
                // Visibility change (pause when hidden)
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.audioEngine.isPlaying) {
                        // Keep playing in background
                    }
                });
            }
            
            setMode(mode) {
                this.currentMode = mode;
                document.body.dataset.mode = mode;
                
                // Update buttons
                this.modeButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                // Show/hide sound grids
                this.productivitySounds.style.display = mode === 'productivity' ? 'grid' : 'none';
                this.sleepSounds.style.display = mode === 'sleep' ? 'grid' : 'none';
                
                // Update timer presets
                this.updateTimerPresets();
                
                // Save preference
                localStorage.setItem('sleepserene-mode', mode);
            }
            
            updateTimerPresets() {
                const presets = TIMER_PRESETS[this.currentMode];
                this.timerPresets.innerHTML = presets.map(p => 
                    `<button class="timer-preset" data-minutes="${p.minutes}">${p.label}</button>`
                ).join('');
            }
            
            selectSound(soundId) {
                const sound = SOUNDS[soundId];
                if (!sound) return;
                
                // Check for binaural beats - show headphone modal
                if (sound.type === 'binaural' && !sessionStorage.getItem('headphone-confirmed')) {
                    this.pendingBinauralSound = soundId;
                    this.headphoneModal.classList.add('show');
                    sessionStorage.setItem('headphone-confirmed', 'true');
                    return;
                }
                
                this.playSound(soundId);
            }
            
            playSound(soundId) {
                const sound = SOUNDS[soundId];
                this.currentSound = soundId;
                
                // Update UI
                this.soundCards.forEach(card => {
                    card.classList.toggle('active', card.dataset.sound === soundId);
                });
                
                // Update track info
                this.trackName.textContent = sound.name;
                this.trackType.textContent = sound.type === 'binaural' ? 'Binaural Beat' : 
                                            sound.type === 'nature' ? 'Nature Sound' : 'Noise';
                
                // Update info panel
                this.infoText.textContent = sound.description;
                this.infoSpecs.style.display = 'flex';
                document.getElementById('specFreq').textContent = sound.specs.freq;
                document.getElementById('specType').textContent = sound.specs.type;
                document.getElementById('specBest').textContent = sound.specs.best;
                
                // Play
                this.audioEngine.play(soundId);
                this.updatePlayButton(true);
                this.requestWakeLock();
                
                // Save preference
                localStorage.setItem('sleepserene-sound', soundId);
            }
            
            togglePlay() {
                if (!this.currentSound) {
                    // Select first sound
                    const firstCard = this.currentMode === 'productivity' 
                        ? this.productivitySounds.querySelector('.sound-card')
                        : this.sleepSounds.querySelector('.sound-card');
                    if (firstCard) {
                        this.selectSound(firstCard.dataset.sound);
                    }
                    return;
                }
                
                if (this.audioEngine.isPlaying) {
                    this.audioEngine.pause();
                    this.updatePlayButton(false);
                    this.releaseWakeLock();
                } else {
                    this.audioEngine.resume();
                    this.updatePlayButton(true);
                    this.requestWakeLock();
                }
            }
            
            updatePlayButton(playing) {
                this.playBtn.classList.toggle('playing', playing);
                this.visualizer.classList.toggle('playing', playing);
            }
            
            setVolume(value) {
                const vol = value / 100;
                this.audioEngine.setVolume(vol);
                this.volumeValue.textContent = `${value}%`;
                localStorage.setItem('sleepserene-volume', value);
            }
            
            toggleMute() {
                const isMuted = this.audioEngine.toggleMute();
                this.updateVolumeIcon(isMuted);
            }
            
            updateVolumeIcon(muted) {
                if (muted) {
                    this.volumeIcon.innerHTML = `
                        <line x1="4" y1="12" x2="8" y2="12"/>
                        <line x1="23" y1="9" x2="17" y2="15"/>
                        <line x1="17" y1="9" x2="23" y2="15"/>
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                    `;
                } else {
                    this.volumeIcon.innerHTML = `
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                    `;
                }
            }
            
            setTimer(minutes) {
                // Clear existing timer
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                
                if (minutes === 0) {
                    this.timerDisplay.textContent = '--:--';
                    return;
                }
                
                this.timerRemaining = minutes * 60;
                this.updateTimerDisplay();
                
                this.timerInterval = setInterval(() => {
                    this.timerRemaining--;
                    this.updateTimerDisplay();
                    
                    if (this.timerRemaining <= 0) {
                        clearInterval(this.timerInterval);
                        this.timerInterval = null;
                        this.audioEngine.stop();
                        this.updatePlayButton(false);
                        this.releaseWakeLock();
                        this.timerDisplay.textContent = '--:--';
                    }
                }, 1000);
            }
            
            updateTimerDisplay() {
                const hours = Math.floor(this.timerRemaining / 3600);
                const mins = Math.floor((this.timerRemaining % 3600) / 60);
                const secs = this.timerRemaining % 60;
                
                if (hours > 0) {
                    this.timerDisplay.textContent = 
                        `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                } else {
                    this.timerDisplay.textContent = 
                        `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
            }
            
            updateTimerPresetUI(activeBtn) {
                this.timerPresets.querySelectorAll('.timer-preset').forEach(btn => {
                    btn.classList.toggle('active', btn === activeBtn);
                });
            }
            
            handleKeyboard(e) {
                // Ignore if typing in input
                if (e.target.tagName === 'INPUT') return;
                
                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        this.togglePlay();
                        break;
                    case 'KeyM':
                        this.toggleMute();
                        break;
                    case 'Digit1':
                    case 'Digit2':
                    case 'Digit3':
                    case 'Digit4':
                    case 'Digit5':
                    case 'Digit6':
                        const index = parseInt(e.code.slice(-1)) - 1;
                        const grid = this.currentMode === 'productivity' 
                            ? this.productivitySounds 
                            : this.sleepSounds;
                        const cards = grid.querySelectorAll('.sound-card');
                        if (cards[index]) {
                            this.selectSound(cards[index].dataset.sound);
                        }
                        break;
                }
            }
            
            async requestWakeLock() {
                if ('wakeLock' in navigator) {
                    try {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                    } catch (err) {
                        console.log('Wake lock request failed:', err);
                    }
                }
            }
            
            releaseWakeLock() {
                if (this.wakeLock) {
                    this.wakeLock.release();
                    this.wakeLock = null;
                }
            }
            
            loadPreferences() {
                const mode = localStorage.getItem('sleepserene-mode');
                if (mode) {
                    this.setMode(mode);
                }
                
                const volume = localStorage.getItem('sleepserene-volume');
                if (volume) {
                    this.volumeSlider.value = volume;
                    this.setVolume(volume);
                }
            }
            
            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        await navigator.serviceWorker.register('sw.js');
                    } catch (err) {
                        console.log('SW registration failed:', err);
                    }
                }
            }
            
            setupPWA() {
                let deferredPrompt;
                const installPrompt = document.getElementById('installPrompt');
                const installBtn = document.getElementById('installBtn');
                const installClose = document.getElementById('installClose');
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    installPrompt.classList.add('show');
                });
                
                installBtn.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        deferredPrompt = null;
                        installPrompt.classList.remove('show');
                    }
                });
                
                installClose.addEventListener('click', () => {
                    installPrompt.classList.remove('show');
                });
                
                window.addEventListener('appinstalled', () => {
                    installPrompt.classList.remove('show');
                });
            }
        }
        
        // Initialize app
        const app = new SleepSereneApp();
    </script>
</body>
</html>
