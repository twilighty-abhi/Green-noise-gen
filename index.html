<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Serene Sleep - Mindful Green Noise</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="A minimalist green noise generator for sleep, relaxation, and focus. Choose from soothing ambiances.">
    <meta name="author" content="Abhiram NJ">
    <meta name="creator" content="Abhiram NJ">
    <meta name="publisher" content="Abhiram NJ">
    <meta name="theme-color" content="#1f2d24">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Serene Sleep">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#1f2d24">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
    <link rel="apple-touch-icon" href="icons/icon.svg">
    <link rel="mask-icon" href="icons/icon.svg" color="#4a8c5c">
    
    <style>
        :root {
            /* Color palette inspired by nature and calm */
            --primary-hue: 140; /* Base green hue */
            --primary-color: hsl(var(--primary-hue), 40%, 45%); /* Deeper green */
            --secondary-color: hsl(var(--primary-hue), 35%, 60%); /* Softer green */
            --accent-color: hsl(60, 50%, 95%); /* Soft cream */
            --dark-color: hsl(var(--primary-hue), 20%, 15%); /* Deep muted green-grey */
            --light-color: hsl(var(--primary-hue), 25%, 85%); /* Light muted green */
            --transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smooth transition */
            --mobile-padding: 15px;
            --desktop-padding: 35px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background: linear-gradient(to bottom, hsl(var(--primary-hue), 20%, 10%), hsl(var(--primary-hue), 25%, 20%));
            color: var(--light-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--mobile-padding);
            transition: background 1s ease;
        }

        /* PWA Install Banner */
        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(120px);
            background: var(--secondary-color);
            color: var(--dark-color);
            padding: 12px 20px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 15px hsla(0, 0%, 0%, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.4s ease, opacity 0.4s ease;
            opacity: 0;
        }

        .install-banner.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .install-banner:hover {
            background: var(--primary-color);
        }

        .install-banner .close-btn {
            margin-left: 8px;
            opacity: 0.7;
            font-size: 18px;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background-color: hsla(var(--primary-hue), 20%, 15%, 0.85);
            border-radius: 20px;
            padding: 25px var(--mobile-padding);
            box-shadow: 0 10px 30px hsla(0, 0%, 0%, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid hsla(var(--primary-hue), 25%, 30%, 0.5);
            transition: background-color 1s ease, padding 0.3s ease;
            overflow-y: auto;
            max-height: calc(100vh - 2 * var(--mobile-padding));
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            color: var(--accent-color);
            font-weight: 300;
            font-size: 24px;
            letter-spacing: 1.5px;
            flex: 1;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--light-color);
            font-size: 18px;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            transition: var(--transition);
            opacity: 0.6;
        }

        .icon-btn:hover, .icon-btn.active {
            opacity: 1;
            background: hsla(var(--primary-hue), 25%, 30%, 0.5);
        }

        .icon-btn.active {
            color: var(--secondary-color);
        }

        .visualization {
            width: 100%;
            aspect-ratio: 16 / 8;
            max-height: 200px;
            border-radius: 15px;
            margin-bottom: 25px;
            overflow: hidden;
            position: relative;
            background: transparent;
            border: 1px solid hsla(var(--primary-hue), 25%, 30%, 0.3);
            transition: opacity 0.5s ease, filter 0.5s ease;
        }

        .visualization.focus-mode {
            opacity: 0.3;
            filter: blur(2px);
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-section-label {
            font-size: 13px;
            color: var(--light-color);
            opacity: 0.6;
            margin-bottom: -10px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sound-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(95px, 1fr));
            gap: 8px;
        }

        .sound-options .btn, .timer-presets .timer-btn {
            font-size: 12px;
            padding: 9px 5px;
            background-color: hsla(var(--primary-hue), 25%, 30%, 0.5);
            color: var(--light-color);
            border: 1px solid transparent;
            border-radius: 8px;
            transition: var(--transition);
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sound-options .btn:hover, .timer-presets .timer-btn:hover {
            background-color: hsla(var(--primary-hue), 30%, 40%, 0.7);
            border-color: hsla(var(--primary-hue), 30%, 50%, 0.5);
        }

        .sound-options .btn.active, .timer-presets .timer-btn.active {
            background-color: var(--secondary-color);
            color: var(--dark-color);
            font-weight: 600;
            border-color: transparent;
            box-shadow: 0 1px 4px hsla(var(--primary-hue), 30%, 20%, 0.2);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .volume-icon {
            font-size: 20px;
            color: var(--secondary-color);
            width: 25px;
            text-align: center;
            opacity: 0.8;
            flex-shrink: 0;
            cursor: pointer;
            transition: var(--transition);
        }

        .volume-icon:hover {
            opacity: 1;
        }

        .volume-icon.muted {
            opacity: 0.4;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: hsla(var(--primary-hue), 25%, 30%, 0.6);
            outline: none;
            transition: background 0.3s ease;
            cursor: pointer;
        }
         .slider:hover {
             background: hsla(var(--primary-hue), 25%, 40%, 0.8);
         }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--secondary-color);
            cursor: pointer;
            transition: var(--transition);
            border: none;
            box-shadow: 0 1px 3px hsla(0, 0%, 0%, 0.3);
        }

        .slider::-webkit-slider-thumb:hover {
            background: var(--primary-color);
            transform: scale(1.15);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--secondary-color);
            cursor: pointer;
            border: none;
            transition: var(--transition);
            box-shadow: 0 1px 3px hsla(0, 0%, 0%, 0.3);
        }

        .slider::-moz-range-thumb:hover {
            background: var(--primary-color);
            transform: scale(1.15);
        }

        .main-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 5px;
        }

        .main-btn {
            background-color: var(--secondary-color);
            color: var(--dark-color);
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            min-width: 100px;
            text-align: center;
            box-shadow: 0 3px 8px hsla(var(--primary-hue), 30%, 20%, 0.3);
        }
        .main-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .main-btn:not(:disabled):hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px hsla(var(--primary-hue), 30%, 20%, 0.4);
        }

        .main-btn.active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: inset 0 2px 4px hsla(0, 0%, 0%, 0.15);
        }

        .main-btn#playBtn.active:not(:disabled) {
             background-color: var(--accent-color);
             color: var(--primary-color);
        }
         .main-btn#stopBtn.active:not(:disabled) {
             background-color: hsl(0, 40%, 60%);
             color: var(--accent-color);
         }


        .timer-section {
            margin-top: 10px;
        }

        .timer-presets {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 5px;
        }

        /* Custom Timer Input */
        .custom-timer-btn {
            position: relative;
        }

        .custom-timer-btn input {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            color: var(--light-color);
            text-align: center;
            font-size: 12px;
            border-radius: 8px;
            padding: 0;
            opacity: 0;
            cursor: pointer;
        }

        .custom-timer-btn input:focus {
            opacity: 1;
            background: hsla(var(--primary-hue), 25%, 20%, 0.9);
            outline: 2px solid var(--secondary-color);
        }

        .custom-timer-btn.has-value input {
            opacity: 1;
            background: var(--secondary-color);
            color: var(--dark-color);
            font-weight: 600;
        }

        .timer-display {
            text-align: center;
            font-size: 18px;
            margin-top: 15px;
            color: var(--accent-color);
            font-weight: 300;
            letter-spacing: 1px;
            height: 25px;
            opacity: 0;
            transition: opacity 0.5s ease;
            line-height: 25px;
        }

        .timer-display.visible {
             opacity: 0.8;
        }

        /* Status indicators */
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            font-size: 11px;
            opacity: 0.5;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-item.active {
            opacity: 1;
            color: var(--secondary-color);
        }

        footer {
            padding: 15px 0 5px 0;
            text-align: center;
            font-size: 12px;
            color: hsla(var(--primary-hue), 25%, 85%, 0.5);
            width: 100%;
        }

        .keyboard-hint {
            font-size: 10px;
            opacity: 0.4;
            margin-top: 5px;
        }

        /* --- Responsive Adjustments --- */
        @media (min-width: 600px) {
             body {
                 padding: 20px;
             }
             .container {
                padding: 30px var(--desktop-padding);
                max-height: calc(100vh - 40px);
             }
             h1 {
                 font-size: 28px;
             }
             .header {
                 margin-bottom: 30px;
             }
             .visualization {
                 aspect-ratio: 16 / 7;
                 max-height: 220px;
                 margin-bottom: 30px;
             }
             .controls {
                 gap: 25px;
             }
             .control-section-label {
                 font-size: 14px;
                 margin-bottom: -15px;
             }
             .sound-options {
                 gap: 10px;
             }
             .sound-options .btn, .timer-presets .timer-btn {
                 font-size: 13px;
                 padding: 10px 5px;
             }
              .volume-control {
                 gap: 15px;
             }
              .volume-icon {
                 font-size: 22px;
                 width: 30px;
             }
             .main-buttons {
                 gap: 20px;
                 margin-top: 10px;
             }
             .main-btn {
                 padding: 14px 35px;
                 font-size: 18px;
                 min-width: 120px;
             }
             .timer-presets {
                 gap: 10px;
                 margin-top: 10px;
             }
             .timer-display {
                 font-size: 20px;
                 margin-top: 20px;
                 height: 30px;
                 line-height: 30px;
             }
              footer {
                 font-size: 13px;
             }
             .keyboard-hint {
                 display: block;
             }
        }

        @media (max-width: 599px) {
            .keyboard-hint {
                display: none;
            }
        }

    </style>
</head>
<body>
    <!-- PWA Install Banner -->
    <div class="install-banner" id="installBanner">
        <span>üì≤</span>
        <span>Install Serene Sleep</span>
        <span class="close-btn" id="closeInstall">√ó</span>
    </div>

    <div class="container">
        <div class="header">
            <div style="width: 60px;"></div>
            <h1>Serene Sleep</h1>
            <div class="header-actions">
                <button class="icon-btn" id="focusBtn" title="Focus Mode (F)" aria-label="Toggle focus mode">üëÅ</button>
                <button class="icon-btn" id="wakeLockBtn" title="Keep Screen On (K)" aria-label="Toggle screen wake lock">üí°</button>
            </div>
        </div>
        <div class="visualization" id="visualizationContainer">
            <canvas id="visualizer"></canvas>
        </div>
        <div class="controls">
             <div class="control-section-label">Choose Ambiance</div>
            <div class="sound-options">
                <button class="btn active" data-sound="forest" data-hue="120">Forest Stream</button>
                <button class="btn" data-sound="waterfall" data-hue="200">Distant Fall</button>
                <button class="btn" data-sound="rain" data-hue="180">Gentle Rain</button>
                <button class="btn" data-sound="trees" data-hue="90">Rustling Trees</button>
                <button class="btn" data-sound="ocean" data-hue="210">Calm Waves</button>
                 <button class="btn" data-sound="ambient" data-hue="270">Deep Space</button>
            </div>

            <div class="volume-control">
                <div class="volume-icon" id="volumeIcon" title="Toggle Mute (M)">üîä</div>
                <input type="range" min="0" max="1" step="0.01" value="0.4" class="slider" id="volume" aria-label="Volume">
            </div>

            <div class="main-buttons">
                <button class="main-btn" id="playBtn">Play</button>
                <button class="main-btn" id="stopBtn">Stop</button>
            </div>

            <div class="timer-section">
                 <div class="control-section-label">Set Timer</div>
                <div class="timer-presets">
                    <button class="timer-btn" data-time="15">15 min</button>
                    <button class="timer-btn" data-time="30">30 min</button>
                    <button class="timer-btn" data-time="90">90 min</button>
                    <button class="timer-btn" data-time="180">3 hrs</button>
                    <div class="timer-btn custom-timer-btn" data-time="custom">
                        <span id="customTimerLabel">Custom</span>
                        <input type="number" id="customTimerInput" min="1" max="480" placeholder="min" aria-label="Custom timer minutes">
                    </div>
                </div>
                <div class="timer-display" id="timerDisplay"></div>
            </div>

            <div class="status-bar">
                <div class="status-item" id="offlineStatus">
                    <span>üì¥</span>
                    <span>Offline Ready</span>
                </div>
                <div class="status-item" id="wakeLockStatus">
                    <span>üí°</span>
                    <span>Screen On</span>
                </div>
            </div>

             <footer>
                <p>Mindful Green Noise ‚Ä¢ Drift into tranquility</p>
                <p class="keyboard-hint">Space: Play/Pause ‚Ä¢ M: Mute ‚Ä¢ 1-6: Sounds ‚Ä¢ F: Focus</p>
                <p style="margin-top: 8px; opacity: 0.4;">Made by Abhiram NJ</p>
            </footer>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Configuration ---
            const PARTICLE_COUNT_FACTOR = 25;
            const BREATH_SPEED = 0.004;
            const FADE_OUT_DURATION = 8;
            const STORAGE_KEY = 'serene-sleep-prefs';

            // --- State Variables ---
            let audioContext = null;
            let noiseNode = null;
            let gainNode = null;
            let analyser = null;
            let isPlaying = false;
            let isStopping = false;
            let timerTimeoutId = null;
            let remainingTime = 0;
            let timerIntervalId = null;
            let currentSound = 'forest';
            let targetHue = 120;
            let currentHue = 120;
            let breathCycle = Math.random() * Math.PI * 2;
            let particles = [];
            let animationFrameId = null;
            let firstInteraction = false;
            let focusMode = false;
            let wakeLock = null;
            let isMuted = false;
            let lastVolume = 0.4;
            let deferredPrompt = null;

            // --- DOM Elements ---
            const canvas = document.getElementById('visualizer');
            const canvasContext = canvas.getContext('2d');
            const volumeSlider = document.getElementById('volume');
            const volumeIcon = document.getElementById('volumeIcon');
            const playBtn = document.getElementById('playBtn');
            const stopBtn = document.getElementById('stopBtn');
            const timerDisplay = document.getElementById('timerDisplay');
            const soundOptionBtns = document.querySelectorAll('.sound-options .btn');
            const timerPresetBtns = document.querySelectorAll('.timer-presets .timer-btn:not(.custom-timer-btn)');
            const customTimerBtn = document.querySelector('.custom-timer-btn');
            const customTimerInput = document.getElementById('customTimerInput');
            const customTimerLabel = document.getElementById('customTimerLabel');
            const bodyElement = document.body;
            const containerElement = document.querySelector('.container');
            const visualizationContainer = document.getElementById('visualizationContainer');
            const focusBtn = document.getElementById('focusBtn');
            const wakeLockBtn = document.getElementById('wakeLockBtn');
            const wakeLockStatus = document.getElementById('wakeLockStatus');
            const offlineStatus = document.getElementById('offlineStatus');
            const installBanner = document.getElementById('installBanner');
            const closeInstall = document.getElementById('closeInstall');

            // --- localStorage Preferences ---
            function loadPreferences() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const prefs = JSON.parse(saved);
                        
                        if (prefs.sound) {
                            currentSound = prefs.sound;
                            soundOptionBtns.forEach(btn => {
                                if (btn.dataset.sound === currentSound) {
                                    btn.classList.add('active');
                                    targetHue = parseInt(btn.dataset.hue, 10);
                                    currentHue = targetHue;
                                } else {
                                    btn.classList.remove('active');
                                }
                            });
                        }
                        
                        if (prefs.volume !== undefined) {
                            volumeSlider.value = prefs.volume;
                            lastVolume = prefs.volume;
                        }
                        
                        if (prefs.focusMode) {
                            focusMode = true;
                            visualizationContainer.classList.add('focus-mode');
                            focusBtn.classList.add('active');
                        }
                        
                        console.log('Preferences loaded:', prefs);
                    }
                } catch (e) {
                    console.warn('Could not load preferences:', e);
                }
            }

            function savePreferences() {
                try {
                    const prefs = {
                        sound: currentSound,
                        volume: parseFloat(volumeSlider.value),
                        focusMode: focusMode
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
                } catch (e) {
                    console.warn('Could not save preferences:', e);
                }
            }

            // --- PWA Install Handling ---
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                setTimeout(() => {
                    installBanner.classList.add('visible');
                }, 3000);
            });

            installBanner.addEventListener('click', async (e) => {
                if (e.target === closeInstall) {
                    installBanner.classList.remove('visible');
                    return;
                }
                
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('Install prompt outcome:', outcome);
                    deferredPrompt = null;
                    installBanner.classList.remove('visible');
                }
            });

            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed');
                installBanner.classList.remove('visible');
                deferredPrompt = null;
            });

            // --- Service Worker Registration ---
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);
                        offlineStatus.classList.add('active');
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            }

            // --- Screen Wake Lock ---
            async function requestWakeLock() {
                if ('wakeLock' in navigator) {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        wakeLockBtn.classList.add('active');
                        wakeLockStatus.classList.add('active');
                        console.log('Wake Lock active');
                        
                        wakeLock.addEventListener('release', () => {
                            console.log('Wake Lock released');
                            wakeLockBtn.classList.remove('active');
                            wakeLockStatus.classList.remove('active');
                        });
                    } catch (err) {
                        console.warn('Wake Lock error:', err);
                    }
                }
            }

            async function releaseWakeLock() {
                if (wakeLock) {
                    await wakeLock.release();
                    wakeLock = null;
                }
            }

            wakeLockBtn.addEventListener('click', async () => {
                if (wakeLock) {
                    await releaseWakeLock();
                } else {
                    await requestWakeLock();
                }
            });

            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    await requestWakeLock();
                }
            });

            // --- Focus Mode ---
            function toggleFocusMode() {
                focusMode = !focusMode;
                visualizationContainer.classList.toggle('focus-mode', focusMode);
                focusBtn.classList.toggle('active', focusMode);
                savePreferences();
            }

            focusBtn.addEventListener('click', toggleFocusMode);

            // --- Canvas & Particle Setup ---
            let width, height;

            function resizeCanvas() {
                width = canvas.clientWidth;
                height = canvas.clientHeight;
                if (canvas.width !== width || canvas.height !== height) {
                    canvas.width = width;
                    canvas.height = height;
                }
                if (width > 0 && height > 0) {
                     createParticles();
                }
            }

            function createParticles() {
                particles = [];
                if (!width || !height) return;
                const particleCount = Math.max(10, Math.floor(width / PARTICLE_COUNT_FACTOR));
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: Math.random() * width,
                        y: Math.random() * height,
                        size: Math.random() * 2.5 + 1.5,
                        opacity: Math.random() * 0.2 + 0.05,
                        speedX: (Math.random() - 0.5) * 0.15,
                        speedY: (Math.random() - 0.5) * 0.15,
                        hueOffset: Math.random() * 30 - 15,
                        phase: Math.random() * Math.PI * 2
                    });
                }
            }

            // --- Audio Initialization and Control ---
            async function initAudio() {
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();

                        if (audioContext.state === 'suspended') {
                            await audioContext.resume();
                        }

                        gainNode = audioContext.createGain();
                        gainNode.gain.setValueAtTime(volumeSlider.value, audioContext.currentTime);
                        gainNode.connect(audioContext.destination);

                        analyser = audioContext.createAnalyser();
                        analyser.fftSize = 512;
                        analyser.smoothingTimeConstant = 0.9;
                        analyser.connect(gainNode);

                        console.log("AudioContext initialized successfully. State:", audioContext.state);
                        firstInteraction = true;
                    } catch (e) {
                        console.error("Error initializing AudioContext:", e);
                        alert("Could not initialize audio. Your browser might not support it or permissions are denied.");
                        audioContext = null;
                    }
                } else if (audioContext.state === 'suspended') {
                     try {
                         await audioContext.resume();
                         console.log("AudioContext resumed. State:", audioContext.state);
                     } catch (e) {
                         console.error("Error resuming AudioContext:", e);
                     }
                }
                 return audioContext !== null;
            }

            function createSoundNode(type) {
                if (!audioContext) return null;

                const bufferSize = audioContext.sampleRate * 2;
                const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }

                const sourceNode = audioContext.createBufferSource();
                sourceNode.buffer = noiseBuffer;
                sourceNode.loop = true;

                const lowShelf = audioContext.createBiquadFilter(); lowShelf.type = 'lowshelf';
                const highShelf = audioContext.createBiquadFilter(); highShelf.type = 'highshelf';
                const midPeak1 = audioContext.createBiquadFilter(); midPeak1.type = 'peaking';
                const midPeak2 = audioContext.createBiquadFilter(); midPeak2.type = 'peaking';

                let lsFreq = 500, lsGain = -15;
                let hsFreq = 4000, hsGain = -15;
                let p1Freq = 1500, p1Q = 1.0, p1Gain = 6;
                let p2Freq = 2500, p2Q = 1.5, p2Gain = 0;

                 switch (type) {
                    case 'forest': lsFreq = 400; lsGain = -12; hsFreq = 4000; hsGain = -16; p1Freq = 1200; p1Q = 0.8; p1Gain = 5; p2Freq = 2200; p2Q = 1.2; p2Gain = 3; break;
                    case 'waterfall': lsFreq = 600; lsGain = -18; hsFreq = 5500; hsGain = -10; p1Freq = 2800; p1Q = 1.2; p1Gain = 8; break;
                    case 'rain': lsFreq = 800; lsGain = -20; hsFreq = 6000; hsGain = -8; p1Freq = 3500; p1Q = 1.5; p1Gain = 6; break;
                    case 'trees': lsFreq = 300; lsGain = -16; hsFreq = 3800; hsGain = -14; p1Freq = 1800; p1Q = 0.7; p1Gain = 7; break;
                    case 'ocean': lsFreq = 250; lsGain = -10; hsFreq = 3000; hsGain = -18; p1Freq = 900; p1Q = 0.6; p1Gain = 4; p2Freq = 1600; p2Q = 1.0; p2Gain = 2; break;
                    case 'ambient': lsFreq = 150; lsGain = -8; hsFreq = 2500; hsGain = -20; p1Freq = 600; p1Q = 0.5; p1Gain = 3; break;
                }

                const now = audioContext.currentTime;
                lowShelf.frequency.setValueAtTime(lsFreq, now); lowShelf.gain.setValueAtTime(lsGain, now);
                highShelf.frequency.setValueAtTime(hsFreq, now); highShelf.gain.setValueAtTime(hsGain, now);
                midPeak1.frequency.setValueAtTime(p1Freq, now); midPeak1.Q.setValueAtTime(p1Q, now); midPeak1.gain.setValueAtTime(p1Gain, now);
                midPeak2.frequency.setValueAtTime(p2Freq, now); midPeak2.Q.setValueAtTime(p2Q, now); midPeak2.gain.setValueAtTime(p2Gain, now);

                sourceNode.connect(lowShelf);
                lowShelf.connect(highShelf);
                highShelf.connect(midPeak1);
                midPeak1.connect(midPeak2);
                midPeak2.connect(analyser);

                return sourceNode;
            }

            async function playCurrentSound() {
                 if (isPlaying || isStopping) return;
                 console.log("Attempting to play...");

                 const audioReady = await initAudio();
                 if (!audioReady) {
                     console.error("Audio context not ready, cannot play.");
                     return;
                 }

                 if (noiseNode) {
                     try {
                         noiseNode.stop();
                         noiseNode.disconnect();
                     } catch (e) { console.warn("Error stopping previous node:", e); }
                     noiseNode = null;
                 }

                 noiseNode = createSoundNode(currentSound);

                 if (!noiseNode) {
                     console.error("Failed to create sound node.");
                     return;
                 }

                 try {
                     gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                     gainNode.gain.setValueAtTime(isMuted ? 0 : volumeSlider.value, audioContext.currentTime);

                     noiseNode.start();
                     isPlaying = true;
                     playBtn.classList.add('active');
                     stopBtn.classList.remove('active');
                     playBtn.disabled = true;
                     stopBtn.disabled = false;
                     startVisualization();
                     
                     if (!wakeLock && 'wakeLock' in navigator) {
                         await requestWakeLock();
                     }
                     
                     console.log("Playback started.");
                 } catch (error) {
                     console.error("Error starting audio playback:", error);
                     isPlaying = false;
                     playBtn.disabled = false;
                     stopBtn.disabled = true;
                 }
            }

             function stopPlayback(fadeOut = false) {
                 if (!isPlaying || isStopping) return;
                 console.log(`Attempting to stop playback (fade: ${fadeOut})`);
                 isStopping = true;
                 stopBtn.disabled = true;

                 clearTimer(false);

                 if (fadeOut && gainNode && audioContext) {
                     const now = audioContext.currentTime;
                     const currentVolume = gainNode.gain.value;
                     gainNode.gain.cancelScheduledValues(now);
                     gainNode.gain.setValueAtTime(currentVolume, now);
                     gainNode.gain.exponentialRampToValueAtTime(0.0001, now + FADE_OUT_DURATION);

                     setTimeout(() => {
                         finalizeStop();
                     }, FADE_OUT_DURATION * 1000);

                 } else {
                     finalizeStop();
                 }
             }

             function finalizeStop() {
                 console.log("Finalizing stop.");
                 if (noiseNode) {
                     try {
                         noiseNode.stop();
                         noiseNode.disconnect();
                     } catch (e) { console.warn("Error stopping node:", e); }
                     noiseNode = null;
                 }
                  if (gainNode && audioContext) {
                      gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                      gainNode.gain.setValueAtTime(isMuted ? 0 : volumeSlider.value, audioContext.currentTime);
                  }

                 isPlaying = false;
                 isStopping = false;
                 stopVisualization();
                 playBtn.classList.remove('active');
                 stopBtn.classList.add('active');
                 playBtn.disabled = false;
                 stopBtn.disabled = true;
                 clearTimerDisplayAndButtons();
                 console.log("Playback stopped.");
             }

            // --- Mute Toggle ---
            function toggleMute() {
                isMuted = !isMuted;
                if (isMuted) {
                    lastVolume = volumeSlider.value;
                    volumeIcon.textContent = 'üîá';
                    volumeIcon.classList.add('muted');
                    if (gainNode && audioContext) {
                        gainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.015);
                    }
                } else {
                    volumeIcon.textContent = 'üîä';
                    volumeIcon.classList.remove('muted');
                    if (gainNode && audioContext) {
                        gainNode.gain.setTargetAtTime(lastVolume, audioContext.currentTime, 0.015);
                    }
                }
            }

            volumeIcon.addEventListener('click', toggleMute);

            // --- Visualization ---
            function startVisualization() {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                resizeCanvas();
                if (width > 0 && height > 0) {
                     console.log("Starting visualization...");
                     animationFrameId = requestAnimationFrame(visualize);
                } else {
                    console.warn("Canvas has no dimensions, cannot start visualization.");
                }
            }

            function stopVisualization() {
                 if (animationFrameId) {
                     cancelAnimationFrame(animationFrameId);
                     animationFrameId = null;
                     console.log("Visualization stopped.");
                     if (canvasContext && width > 0 && height > 0) {
                        canvasContext.fillStyle = `hsla(${currentHue}, 20%, 15%, 0.5)`;
                        canvasContext.fillRect(0, 0, width, height);
                     }
                 }
             }


            function visualize() {
                animationFrameId = requestAnimationFrame(visualize);

                if (!width || !height) return;

                currentHue += (targetHue - currentHue) * 0.05;

                bodyElement.style.setProperty('--primary-hue', Math.round(currentHue));
                containerElement.style.setProperty('--primary-hue', Math.round(currentHue));

                const gradient = canvasContext.createRadialGradient(
                    width / 2, height / 2, 0,
                    width / 2, height / 2, Math.max(width, height) * 0.7
                );
                gradient.addColorStop(0, `hsla(${currentHue}, 50%, 20%, 0.8)`);
                gradient.addColorStop(1, `hsla(${currentHue}, 40%, 10%, 0.9)`);
                canvasContext.fillStyle = gradient;
                canvasContext.fillRect(0, 0, width, height);

                breathCycle += BREATH_SPEED;
                breathProgress = (Math.sin(breathCycle) + 1) / 2;

                const centerX = width / 2;
                const centerY = height / 2;
                const baseRadius = Math.min(width, height) * 0.1;
                const breathAmplitude = Math.min(width, height) * 0.08;
                const currentRadius = baseRadius + breathProgress * breathAmplitude;

                const glowRadius = currentRadius * 2.5;
                const glowGradient = canvasContext.createRadialGradient(
                    centerX, centerY, currentRadius * 0.5,
                    centerX, centerY, glowRadius
                );
                glowGradient.addColorStop(0, `hsla(${currentHue}, 70%, 60%, 0.15)`);
                glowGradient.addColorStop(0.5, `hsla(${currentHue}, 70%, 55%, 0.05)`);
                glowGradient.addColorStop(1, `hsla(${currentHue}, 60%, 50%, 0)`);
                canvasContext.beginPath();
                canvasContext.arc(centerX, centerY, glowRadius, 0, Math.PI * 2);
                canvasContext.fillStyle = glowGradient;
                canvasContext.fill();

                for (let i = 0; i < particles.length; i++) {
                    const p = particles[i];

                    p.x += p.speedX;
                    p.y += p.speedY;
                    const angle = p.phase + breathCycle * 0.1;
                    p.x += Math.cos(angle) * 0.05;
                    p.y += Math.sin(angle) * 0.05;

                    const dx = p.x - centerX;
                    const dy = p.y - centerY;
                    const dist = Math.sqrt(dx * dx + dy * dy) + 0.1;
                    const pushPullFactor = (breathProgress - 0.5) * 0.1 * (1 - Math.min(1, dist / (width * 0.4)));
                    p.x += (dx / dist) * pushPullFactor;
                    p.y += (dy / dist) * pushPullFactor;

                    if (p.x < -p.size) p.x = width + p.size;
                    if (p.x > width + p.size) p.x = -p.size;
                    if (p.y < -p.size) p.y = height + p.size;
                    if (p.y > height + p.size) p.y = -p.size;

                    const particleHue = (currentHue + p.hueOffset + 180) % 360;
                    const particleOpacity = p.opacity * (0.5 + breathProgress * 0.5);

                    canvasContext.beginPath();
                    canvasContext.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    const particleGradient = canvasContext.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size * 1.5);
                    particleGradient.addColorStop(0, `hsla(${particleHue}, 60%, 80%, ${particleOpacity * 0.8})`);
                    particleGradient.addColorStop(1, `hsla(${particleHue}, 50%, 70%, 0)`);
                    canvasContext.fillStyle = particleGradient;
                    canvasContext.fill();
                }
            }


            // --- Timer Logic ---
            function startTimer(minutes) {
                clearTimer(false);

                remainingTime = minutes * 60;
                updateTimerDisplay();
                timerDisplay.classList.add('visible');

                timerIntervalId = setInterval(updateTimerDisplay, 1000);

                timerTimeoutId = setTimeout(() => {
                    console.log("Timer finished.");
                    stopPlayback(true);
                }, minutes * 60 * 1000);
                 console.log(`Timer started for ${minutes} minutes.`);
            }

             function clearTimer(updateUI = true) {
                 if (timerTimeoutId) clearTimeout(timerTimeoutId);
                 if (timerIntervalId) clearInterval(timerIntervalId);
                 timerTimeoutId = null;
                 timerIntervalId = null;
                 remainingTime = 0;
                 if(updateUI) {
                    clearTimerDisplayAndButtons();
                 }
                 console.log("Timer cleared.");
             }

             function clearTimerDisplayAndButtons() {
                  timerDisplay.textContent = '';
                  timerDisplay.classList.remove('visible');
                  timerPresetBtns.forEach(btn => btn.classList.remove('active'));
                  customTimerBtn.classList.remove('active');
                  customTimerBtn.classList.remove('has-value');
                  customTimerInput.value = '';
                  customTimerLabel.textContent = 'Custom';
             }

            function updateTimerDisplay() {
                if (remainingTime <= 0) {
                    clearTimer();
                    return;
                }

                const hours = Math.floor(remainingTime / 3600);
                const minutes = Math.floor((remainingTime % 3600) / 60);
                const seconds = remainingTime % 60;

                let displayText = '';
                if (hours > 0) displayText += `${hours}h `;
                displayText += `${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;

                timerDisplay.textContent = displayText;
                remainingTime--;
            }

            // --- Custom Timer ---
            customTimerInput.addEventListener('focus', () => {
                customTimerLabel.style.opacity = '0';
            });

            customTimerInput.addEventListener('blur', () => {
                if (!customTimerInput.value) {
                    customTimerLabel.style.opacity = '1';
                }
            });

            customTimerInput.addEventListener('change', async function() {
                const minutes = parseInt(this.value);
                if (!isNaN(minutes) && minutes > 0 && minutes <= 480) {
                    timerPresetBtns.forEach(btn => btn.classList.remove('active'));
                    customTimerBtn.classList.add('active');
                    customTimerBtn.classList.add('has-value');
                    customTimerLabel.textContent = `${minutes}m`;

                    if (!audioContext) {
                        const success = await initAudio();
                        if (!success) return;
                    }

                    if (!isPlaying) {
                        await playCurrentSound();
                    }
                    
                    if (isPlaying) {
                        startTimer(minutes);
                    }
                }
            });

            customTimerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    customTimerInput.blur();
                    const event = new Event('change');
                    customTimerInput.dispatchEvent(event);
                }
            });

            // --- Event Listeners ---
            soundOptionBtns.forEach(button => {
                button.addEventListener('click', async function() {
                     if (isStopping) return;

                     if (!audioContext) {
                         const success = await initAudio();
                         if (!success) return;
                     }

                     const selectedSound = this.dataset.sound;
                     const selectedHue = parseInt(this.dataset.hue, 10);

                     if (currentSound === selectedSound && isPlaying) return;

                     console.log(`Sound selected: ${selectedSound}`);

                     currentSound = selectedSound;
                     targetHue = selectedHue;

                     soundOptionBtns.forEach(btn => btn.classList.remove('active'));
                     this.classList.add('active');
                     
                     savePreferences();

                     if (isPlaying) {
                        stopPlayback(false);
                         setTimeout(playCurrentSound, 50);
                     } else {
                         playCurrentSound();
                     }
                });
            });

            playBtn.addEventListener('click', playCurrentSound);
            stopBtn.addEventListener('click', () => stopPlayback(false));

            volumeSlider.addEventListener('input', function() {
                if (isMuted) {
                    isMuted = false;
                    volumeIcon.textContent = 'üîä';
                    volumeIcon.classList.remove('muted');
                }
                lastVolume = this.value;
                if (gainNode && audioContext) {
                    gainNode.gain.setTargetAtTime(this.value, audioContext.currentTime, 0.015);
                }
                savePreferences();
            });

            timerPresetBtns.forEach(button => {
                button.addEventListener('click', async function() {
                    if (isStopping) return;

                    const minutes = parseInt(this.dataset.time);
                    if (!isNaN(minutes)) {
                        timerPresetBtns.forEach(btn => btn.classList.remove('active'));
                        customTimerBtn.classList.remove('active');
                        customTimerBtn.classList.remove('has-value');
                        customTimerInput.value = '';
                        customTimerLabel.textContent = 'Custom';
                        this.classList.add('active');

                        if (!audioContext) {
                             const success = await initAudio();
                             if (!success) return;
                         }

                        if (!isPlaying) {
                            await playCurrentSound();
                        }
                        if (isPlaying) {
                             startTimer(minutes);
                        } else {
                            console.warn("Playback did not start, timer not set.");
                            clearTimerDisplayAndButtons();
                        }
                    }
                });
            });

            // --- Keyboard Shortcuts ---
            document.addEventListener('keydown', async (e) => {
                if (e.target.tagName === 'INPUT') return;

                switch(e.key.toLowerCase()) {
                    case ' ':
                        e.preventDefault();
                        if (isPlaying) {
                            stopPlayback(false);
                        } else {
                            playCurrentSound();
                        }
                        break;
                    case 'm':
                        toggleMute();
                        break;
                    case 'f':
                        toggleFocusMode();
                        break;
                    case 'k':
                        if (wakeLock) {
                            await releaseWakeLock();
                        } else {
                            await requestWakeLock();
                        }
                        break;
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                    case '5':
                    case '6':
                        const index = parseInt(e.key) - 1;
                        if (soundOptionBtns[index]) {
                            soundOptionBtns[index].click();
                        }
                        break;
                }
            });

             // Handle visibility change for visualization
             document.addEventListener('visibilitychange', () => {
                 if (document.hidden) {
                     if (animationFrameId) {
                         cancelAnimationFrame(animationFrameId);
                         animationFrameId = null;
                         console.log("Visualization paused due to tab hidden.");
                     }
                 } else {
                     if (isPlaying && !animationFrameId) {
                         startVisualization();
                         console.log("Visualization resumed due to tab visible.");
                     }
                 }
             });

             // Handle window resize
             let resizeTimeout;
             window.addEventListener('resize', () => {
                 clearTimeout(resizeTimeout);
                 resizeTimeout = setTimeout(() => {
                      console.log("Window resized");
                      resizeCanvas();
                      if (isPlaying && animationFrameId) {
                           cancelAnimationFrame(animationFrameId);
                           animationFrameId = null;
                      }
                       if (isPlaying && !animationFrameId) {
                          startVisualization();
                       }
                 }, 250);
             });


            // --- Initial Setup ---
            loadPreferences();
            resizeCanvas();
            stopBtn.disabled = true;
            playBtn.disabled = false;
            stopBtn.classList.add('active');

             function handleFirstInteraction() {
                if (!firstInteraction) {
                    console.log("First user interaction detected.");
                    initAudio().then(success => {
                        if (success) {
                             // Audio ready
                        }
                     });
                     document.removeEventListener('click', handleFirstInteraction, true);
                     document.removeEventListener('touchstart', handleFirstInteraction, true);
                 }
             }
             document.addEventListener('click', handleFirstInteraction, true);
             document.addEventListener('touchstart', handleFirstInteraction, true);


            console.log("Serene Sleep PWA Initialized.");

        });
    </script>
</body>
</html>
